import { Router } from 'express'; import { prisma } from '../prisma/client.js'; import { verify } from '../utils/signer.js'; export const publicRouter=Router(); publicRouter.get('/',async(req,res)=>{const org=(req.query.org as string)||''; const email=((req.query.email as string)||'').toLowerCase(); const sig=(req.query.sig as string)||''; if(!org||!email||!sig||!verify(org,email,sig)) return res.status(400).send('<h3>Invalid unsubscribe link.</h3>'); await prisma.suppression.upsert({where:{organizationId_email:{organizationId:org,email}},update:{},create:{organizationId:org,email,reason:'unsubscribe'}}); res.send('<h3>You are unsubscribed. You can close this tab.</h3>')})
