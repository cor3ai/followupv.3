import { Router } from 'express'; import { prisma } from '../prisma/client.js'; export const router=Router(); router.post('/intake',async(req,res)=>{const {organizationId,contact,type,context}=req.body||{}; if(!organizationId||!type||!contact?.email) return res.status(400).json({error:'missing fields'}); let found=await prisma.contact.findFirst({where:{organizationId,email:contact.email.toLowerCase()}}); if(!found){found=await prisma.contact.create({data:{organizationId,email:contact.email.toLowerCase(),name:contact?.name||null,lastInteractionAt:new Date()}})} else {await prisma.contact.update({where:{id:found.id},data:{lastInteractionAt:new Date()}})} await prisma.event.create({data:{organizationId,contactId:found.id,type,payload:context||{}}}); res.json({ok:true,contactId:found.id})})
