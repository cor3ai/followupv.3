import { Router } from 'express'; import { prisma } from '../prisma/client.js'; import { sendEmail } from '../services/email.js'; export const router=Router(); router.post('/trial-nudge',async(req,res)=>{const key=req.headers['x-api-key']; if(!key||key!==process.env.NUDGE_API_KEY) return res.status(401).json({error:'unauthorized'}); const now=new Date(); const min=new Date(now.getTime()-7*24*60*60*1000); const max=new Date(now.getTime()-24*60*60*1000); const orgs=await prisma.organization.findMany({where:{createdAt:{gte:min,lte:max}},include:{users:true}}); let notified=0; for(const org of orgs){const cnt=await prisma.message.count({where:{organizationId:org.id,status:'sent'}}); if(cnt===0){const owner=org.users.find(u=>u.id===org.ownerUserId)||org.users[0]; if(owner?.email){await sendEmail({to:owner.email,subject:'Need help sending your first FollowUp?',html:`<p>Just one step to goâ€”import contacts or add one manually and click "Generate".</p><p><a href="${process.env.APP_URL}/app">Open your dashboard</a></p>`}); notified++}}} res.json({ok:true,notified})}); router.post('/revenue',async(req,res)=>{const key=req.headers['x-api-key']; const allowed=process.env.REVENUE_API_KEY||process.env.NUDGE_API_KEY; if(!key||key!==allowed) return res.status(401).json({error:'unauthorized'}); const {organizationId,contactEmail,amountCents,currency,couponCode,messageId,occurredAt}=req.body||{}; if(!organizationId||!amountCents) return res.status(400).json({error:'organizationId and amountCents required'}); let cid=undefined; if(contactEmail){const c=await prisma.contact.findFirst({where:{organizationId,email:contactEmail.toLowerCase()}}); cid=c?.id} const evt=await prisma.revenueEvent.create({data:{organizationId,contactId:cid,amountCents:Math.floor(amountCents),currency:(currency||'USD').toUpperCase(),couponCode:couponCode?couponCode.toUpperCase():null,source:'webhook',messageId:messageId||null,occurredAt:occurredAt?new Date(occurredAt):new Date()}}); res.json({ok:true,id:evt.id})})
