import fetch from 'node-fetch'; async function token(){const p=new URLSearchParams(); p.set('client_id',process.env.MS_CLIENT_ID as string); p.set('client_secret',process.env.MS_CLIENT_SECRET as string); p.set('refresh_token',process.env.MS_REFRESH_TOKEN as string); p.set('grant_type','refresh_token'); p.set('scope','https://graph.microsoft.com/.default offline_access'); const t=process.env.MS_TENANT_ID||'common'; const r=await fetch(`https://login.microsoftonline.com/${t}/oauth2/v2.0/token`,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:p}); const j=await r.json(); if(!j.access_token) throw new Error('OUTLOOK token'); return j.access_token } export async function sendWithOutlook(o:{to:string,subject:string,html:string,fromEmail?:string,fromName?:string}){const at=await token(); const from=o.fromEmail||process.env.SENDGRID_FROM_EMAIL as string; const body={message:{subject:o.subject, body:{contentType:'HTML',content:o.html}, from:{emailAddress:{address:from,name:o.fromName||process.env.SENDGRID_FROM_NAME}}, toRecipients:[{emailAddress:{address:o.to}}]}, saveToSentItems:'true'}; const user=process.env.MS_USER_ID||'me'; const r=await fetch(`https://graph.microsoft.com/v1.0/users/${user}/sendMail`,{method:'POST',headers:{Authorization:`Bearer ${at}`,'Content-Type':'application/json'},body:JSON.stringify(body)}); if(!r.ok) throw new Error('OUTLOOK send failed')}
