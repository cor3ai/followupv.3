import fetch from 'node-fetch'; import { createMimeMessage } from '../util_mime.js'; async function token(){const b=new URLSearchParams(); b.set('client_id',process.env.GMAIL_CLIENT_ID as string); b.set('client_secret',process.env.GMAIL_CLIENT_SECRET as string); b.set('refresh_token',process.env.GMAIL_REFRESH_TOKEN as string); b.set('grant_type','refresh_token'); const r=await fetch('https://oauth2.googleapis.com/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:b}); const j=await r.json(); if(!j.access_token) throw new Error('GMAIL token'); return j.access_token} export async function sendWithGmail(o:{to:string,subject:string,html:string,fromEmail?:string,fromName?:string}){const at=await token(); const from=`${o.fromName||process.env.SENDGRID_FROM_NAME} <${o.fromEmail||process.env.SENDGRID_FROM_EMAIL}>`; const raw=createMimeMessage({to:o.to, from, subject:o.subject, html:o.html}); const r=await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send',{method:'POST',headers:{Authorization:`Bearer ${at}`,'Content-Type':'application/json'},body:JSON.stringify({raw})}); if(!r.ok) throw new Error('GMAIL send failed')}
